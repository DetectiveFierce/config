#!/usr/bin/env bash
set -euo pipefail

# recent-projects-fzf [editor|fm|term]
ACTION="${1:-editor}"
OPEN_EDITOR="${OPEN_EDITOR:-cursor}"
OPEN_FM="${OPEN_FM:-thunar}"
OPEN_TERM="${OPEN_TERM:-foot}"

need() { command -v "$1" >/dev/null 2>&1 || { echo "Missing: $1" >&2; exit 1; }; }
need fzf
need sqlite3

# Paths
CURSOR_DB="$HOME/.config/Cursor/User/globalStorage/state.vscdb"
CODE_DB="$HOME/.config/Code/User/globalStorage/state.vscdb"
HIDDEN_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/recent-projects-hidden.txt"
mkdir -p "$(dirname "$HIDDEN_FILE")"
touch "$HIDDEN_FILE"

# Fast URL decode in awk (POSIX); decodes %XX and +, strips file://, query/fragment
urldecode_awk='
function urldecode(s,   i,c,hex,out) {
  out=""
  for (i=1;i<=length(s);i++) {
    c=substr(s,i,1)
    if (c=="%") {
      hex=substr(s,i+1,2)
      if (hex ~ /^[0-9A-Fa-f]{2}$/) {
        out=out sprintf("%c", strtonum("0x" hex))
        i+=2
      } else {
        out=out c
      }
    } else if (c=="+") {
      out=out " "
    } else {
      out=out c
    }
  }
  return out
}
{
  gsub(/^file:\/\//, "", $0)
  sub(/\?.*$/,"", $0)
  sub(/#.*/,"", $0)
  print urldecode($0)
}'

# Extract folder paths from DB (fast, no jq):
#  - Pull JSON once
#  - Grep only "folderUri" lines
#  - Strip JSON syntax and decode
collect_from_db() {
  local db="$1"
  [[ -f "$db" ]] || return 0
  # Get the JSON blob; if empty, return
  local json
  json="$(sqlite3 -batch "$db" "SELECT value FROM ItemTable WHERE key='history.recentlyOpenedPathsList' LIMIT 1;")" || true
  [[ -n "$json" ]] || return 0

  # Filter just folderUri values (ignore fileUri to stay fast)
  printf '%s\n' "$json" \
    | grep -o '"folderUri"[^"]*"[^"]*"' \
    | sed -E 's/^.*"folderUri"[[:space:]]*:[[:space:]]*"([^"]*)".*$/\1/' \
    | awk "$urldecode_awk" \
    | awk 'BEGIN{h=ENVIRON["HOME"]} /^~(\/|$)/{$0=h substr($0,2)} {print}' \
    | awk -v RS='\n' '!seen[$0]++' \
    | while IFS= read -r p; do
        [[ -d "$p" ]] && printf '%s\n' "$p"
      done
}

# Build recent list (Cursor first, then Code), unique while preserving order
mapfile -t recents_raw < <(
  { collect_from_db "$CURSOR_DB"; collect_from_db "$CODE_DB"; } 2>/dev/null \
    | awk '!seen[$0]++'
)

# If nothing, exit quickly so the launcher returns
if [[ ${#recents_raw[@]} -eq 0 ]]; then
  echo "No recent folders in Cursor/Code."
  exit 0
fi

# Filter out hidden entries (fast path)
if [[ -s "$HIDDEN_FILE" ]]; then
  mapfile -t recents < <(printf '%s\n' "${recents_raw[@]}" | grep -Fvx -f "$HIDDEN_FILE" || true)
else
  recents=("${recents_raw[@]}")
fi

# Prepare a “reload” command string with precomputed raw list to avoid re-sqlite
# We pass it via env to avoid quoting hell.
RECENTS_RAW_JOINED="$(printf '%s\n' "${recents_raw[@]}")"
export RECENTS_RAW_JOINED
export HIDDEN_FILE

# fzf:
# - Delete hides selection: append to HIDDEN_FILE and reload from precomputed raw list.
# - Minimal preview (path echo) only; zero lag.
choice="$(
  printf '%s\n' "${recents[@]}" \
    | fzf \
        --prompt='Recent> ' \
        --height=100% \
        --reverse \
        --bind "del:execute-silent(echo {} >> \"$HIDDEN_FILE\")+reload(sh -c 'printf \"%s\n\" \"\$RECENTS_RAW_JOINED\" | grep -Fvx -f \"$HIDDEN_FILE\" 2>/dev/null')" \
        --preview 'echo {}' \
        --preview-window down,1,wrap
)"

[[ -n "$choice" ]] || exit 0

# Fast launchers, no extra subshells
case "${ACTION}" in
  fm)
    if command -v "$OPEN_FM" >/dev/null 2>&1; then
      setsid -f "$OPEN_FM" "$choice" >/dev/null 2>&1
    else
      setsid -f xdg-open "$choice" >/dev/null 2>&1
    fi
    ;;
  term)
    case "$OPEN_TERM" in
      kitty)    setsid -f kitty --directory "$choice" >/dev/null 2>&1 ;;
      alacritty) setsid -f alacritty --working-directory "$choice" >/dev/null 2>&1 ;;
      foot)     setsid -f foot --working-directory="$choice" >/dev/null 2>&1 ;;
      wezterm)  setsid -f wezterm start --cwd "$choice" >/dev/null 2>&1 ;;
      *)        setsid -f "$OPEN_TERM" -e bash -lc "cd \"$choice\"; exec \$SHELL" >/dev/null 2>&1 ;;
    esac
    ;;
  *)
    if command -v "$OPEN_EDITOR" >/dev/null 2>&1; then
      setsid -f "$OPEN_EDITOR" "$choice" >/dev/null 2>&1
    elif command -v code >/dev/null 2>&1; then
      setsid -f code "$choice" >/dev/null 2>&1
    else
      setsid -f xdg-open "$choice" >/dev/null 2>&1
    fi
    ;;
esac